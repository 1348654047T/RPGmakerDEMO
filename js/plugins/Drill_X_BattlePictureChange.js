//=============================================================================
// Drill_X_BattlePictureChange.js
//=============================================================================

/*:
 * @plugindesc [v1.1]        战斗 - 角色立绘切换[扩展]
 * @author Drill_up
 * 
 *
 * @param ----角色图像组----
 * @default 
 *
 * @param 角色图像-1
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 * @param 角色图像-2
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 * @param 角色图像-3
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 * @param 角色图像-4
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 * @param 角色图像-5
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 * @param 角色图像-6
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 * @param 角色图像-7
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 * @param 角色图像-8
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 * @param 角色图像-9
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 * @param 角色图像-10
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 * @param 角色图像-11
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 * @param 角色图像-12
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 * @param 角色图像-13
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 * @param 角色图像-14
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 * @param 角色图像-15
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 * @param 角色图像-16
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 * @param 角色图像-17
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 * @param 角色图像-18
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 * @param 角色图像-19
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 * @param 角色图像-20
 * @parent ----角色图像组----
 * @desc 角色前视图或者背景图的图片资源。MOG_ActorPictureCM 战斗-角色图像 插件。
 * @default 
 * @require 1
 * @dir img/pictures/
 * @type file
 *
 *
 * @param ----角色头像组----
 * @default 
 *
 * @param 角色头像-1
 * @parent ----角色头像组----
 * @desc 角色头像的图片资源。MOG_BattleHud 战斗-角色窗口 插件。
 * @default 
 * @require 1
 * @dir img/battlehud/
 * @type file
 *
 * @param 角色头像-2
 * @parent ----角色头像组----
 * @desc 角色头像的图片资源。MOG_BattleHud 战斗-角色窗口 插件。
 * @default 
 * @require 1
 * @dir img/battlehud/
 * @type file
 *
 * @param 角色头像-3
 * @parent ----角色头像组----
 * @desc 角色头像的图片资源。MOG_BattleHud 战斗-角色窗口 插件。
 * @default 
 * @require 1
 * @dir img/battlehud/
 * @type file
 *
 * @param 角色头像-4
 * @parent ----角色头像组----
 * @desc 角色头像的图片资源。MOG_BattleHud 战斗-角色窗口 插件。
 * @default 
 * @require 1
 * @dir img/battlehud/
 * @type file
 *
 * @param 角色头像-5
 * @parent ----角色头像组----
 * @desc 角色头像的图片资源。MOG_BattleHud 战斗-角色窗口 插件。
 * @default 
 * @require 1
 * @dir img/battlehud/
 * @type file
 *
 * @param 角色头像-6
 * @parent ----角色头像组----
 * @desc 角色头像的图片资源。MOG_BattleHud 战斗-角色窗口 插件。
 * @default 
 * @require 1
 * @dir img/battlehud/
 * @type file
 *
 * @param 角色头像-7
 * @parent ----角色头像组----
 * @desc 角色头像的图片资源。MOG_BattleHud 战斗-角色窗口 插件。
 * @default 
 * @require 1
 * @dir img/battlehud/
 * @type file
 *
 * @param 角色头像-8
 * @parent ----角色头像组----
 * @desc 角色头像的图片资源。MOG_BattleHud 战斗-角色窗口 插件。
 * @default 
 * @require 1
 * @dir img/battlehud/
 * @type file
 *
 * @param 角色头像-9
 * @parent ----角色头像组----
 * @desc 角色头像的图片资源。MOG_BattleHud 战斗-角色窗口 插件。
 * @default 
 * @require 1
 * @dir img/battlehud/
 * @type file
 *
 * @param 角色头像-10
 * @parent ----角色头像组----
 * @desc 角色头像的图片资源。MOG_BattleHud 战斗-角色窗口 插件。
 * @default 
 * @require 1
 * @dir img/battlehud/
 * @type file
 *
 * @help  
 * =============================================================================
 * +++ Drill_X_BattlePictureChange +++
 * 作者：Drill_up
 * 如果你有兴趣，也可以来看看我的mog中文全翻译插件哦ヽ(*。>Д<)o゜
 * https://rpg.blue/thread-409713-1-1.html
 * =============================================================================
 * 该插件在角色图像和角色窗口的基础上提供切换立绘支持。
 * 【支持插件关联资源的打包、加密】
 *
 * -----------------------------------------------------------------------------
 * ----插件扩展
 * 插件只对指定插件扩展，如果没有使用目标插件，则该插件没有任何效果。
 * 作用于：
 *   - MOG_ActorPictureCM 战斗-角色图像
 *     给目标插件提供插件指令支持，以切换角色前视图和背景图。
 *   - MOG_BattleHud 战斗-角色窗口
 *     给目标插件提供插件指令支持，以切换角色头像。
 * 
 * -----------------------------------------------------------------------------
 * ----激活条件 - 战斗-角色图像
 * 你可以通过插件设置战斗时的角色图像:
 *
 * 插件指令（前视图）：>角色立绘 : A : 切换前视图 : B
 * 插件指令（背景图）：>角色立绘 : A : 切换背景图 : B
 * 插件指令（还原）：  >角色立绘 : A : 还原图像
 *
 * 参数A：角色的id
 * 参数B：配置的角色图像编号
 * 插件指令任何时候都可以设置，如果不还原，战斗结束后立绘才会自动还原。
 * 
 * 示例：
 * 插件指令：>角色立绘 : 5 : 切换前视图 : 1
 * （5号角色的前视图切换为配置的1号角色图像）
 * 插件指令：>角色立绘 : 5 : 还原图像
 * （5号角色的前视图和背景图恢复原状）
 * 
 * -----------------------------------------------------------------------------
 * ----激活条件 - 战斗-角色窗口
 * 你可以通过插件设置战斗角色窗口中的头像:
 *
 * 插件指令（头像）：>角色立绘 : A : 切换头像 : C
 * 插件指令（还原）：>角色立绘 : A : 还原头像
 *
 * 参数A：角色的id
 * 参数C：配置的角色头像编号
 * 插件指令任何时候都可以设置，如果不还原，战斗结束后立绘才会自动还原。
 * 
 * 示例：
 * 插件指令：>角色立绘 : 5 : 切换头像 : 1
 * （5号角色的头像切换为配置的1号角色图像）
 * 插件指令：>角色立绘 : 5 : 还原头像
 * （5号角色的头像恢复原状）
 *
 * -----------------------------------------------------------------------------
 * ----更新日志
 * [v1.0]
 * 完成插件ヽ(*。>Д<)o゜
 * [v1.1]
 * 修复了单人战斗时，立绘无法切换的bug。规范了插件指令。
 */
 
//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
//		临时全局变量	DrillUp.xxx
//		临时局部变量	无
//		存储数据变量	无
//		全局存储变量	无
//		覆盖重写方法	无
//
//插件记录：
//		该插件有 $gameSystem._drill_xxx ，但都为临时使用的变量。
//		mog的角色图像有个大坑，只有一个人战斗时，立绘无法切换。
//		原理实在琢磨不清，是if (this._actor_cm_data[0] != BattleManager.actor())的问题，但是这个条件又不能去掉。（去掉直接不显示立绘）
//		目前的解决方法是，绕着这个条件，新写变换条件。（mog代码居然那么稀烂）
//
 
//=============================================================================
// ** 变量获取
//=============================================================================
　　var Imported = Imported || {};
　　Imported.Drill_X_BattlePictureChange = true;
　　var DrillUp = DrillUp || {}; 

    DrillUp.parameters = PluginManager.parameters('Drill_X_BattlePictureChange');
	
	DrillUp.battle_pic_list_length = 20;
	DrillUp.battle_pic_list = {};
	for (var i = 1; i <= DrillUp.battle_pic_list_length ; i++ ) {
		DrillUp.battle_pic_list[i] = DrillUp.parameters['角色图像-' + String(i) ];
	};
	DrillUp.battle_face_list_length = 10;
	DrillUp.battle_face_list = {};
	for (var i = 1; i <= DrillUp.battle_face_list_length ; i++ ) {
		DrillUp.battle_face_list[i] = DrillUp.parameters['角色头像-' + String(i) ];
	};

//=============================================================================
// ** 插件指令
//=============================================================================
var _drill_bPic_change_pluginCommand = Game_Interpreter.prototype.pluginCommand;
Game_Interpreter.prototype.pluginCommand = function(command, args) {
	_drill_bPic_change_pluginCommand.call(this, command, args);
	if (command === '>角色立绘') {
		if(args.length >= 4){
			var temp1 = Number(args[1]);
			if(args.length >= 6){ var temp2 = Number(args[5]); }
			var type = String(args[3]);
			if( type == '切换前视图' ){
				$gameSystem._drill_cm1_change = true;
				$gameSystem._drill_cm1_actor_id = temp1;
				$gameSystem._drill_cm1_new_pic_id = temp2;
			}
			if( type == '切换背景图' ){
				$gameSystem._drill_cm2_change = true;
				$gameSystem._drill_cm2_actor_id = temp1;
				$gameSystem._drill_cm2_new_pic_id = temp2;
			}
			if( type == '还原图像' ){
				$gameSystem._drill_cm12_reset = true;
				$gameSystem._drill_cm12_actor_id = temp1;
			}
			if( type == '切换头像' ){
				$gameSystem._drill_bHud_change = true;
				$gameSystem._drill_bHud_face_id = temp1;
				$gameSystem._drill_bHud_new_face_id = temp2;
			}
			if( type == '还原头像' ){
				$gameSystem._drill_bHud_reset = true;
				$gameSystem._drill_bHud_reset_id = temp1;
			}
			
		}
	}
};

//=============================================================================
// ** 角色图像
//=============================================================================

if(Imported.MOG_ActorPictureCM){
	//==============================
	// * Load Actor CM Pictures
	//==============================	
	var _drill_actor_cm_load = Actor_CMPicture.prototype.load_actor_cm_pictures;
	Actor_CMPicture.prototype.load_actor_cm_pictures = function() {
		_drill_actor_cm_load.call(this);
		if( $gameSystem._drill_cm1_change ){
			$gameSystem._drill_cm1_change = false;
			this._actor_cm_img[ $gameSystem._drill_cm1_actor_id ] = ImageManager.loadPicture(DrillUp.battle_pic_list[ $gameSystem._drill_cm1_new_pic_id ]);
		}
		if( $gameSystem._drill_cm2_change ){
			$gameSystem._drill_cm2_change = false;
			this._actor_cm2_img[ $gameSystem._drill_cm2_actor_id ] = ImageManager.loadPicture(DrillUp.battle_pic_list[ $gameSystem._drill_cm2_new_pic_id ]);
		}
	}
	
	//==============================
	// * Actor CM update（处理单人战斗时立绘换不了问题）
	//==============================
	var _drill_actor_cm_update = Actor_CMPicture.prototype.update;
	Actor_CMPicture.prototype.update = function() {
		if ($gameTemp._actor_cm_visible) {
			if (this._actor_cm_data[0] == BattleManager.actor() ) {
				var actor_id = BattleManager.actor()._actorId;
				if( $gameSystem._drill_cm1_change ){
					$gameSystem._drill_cm1_change = false;
					this._actor_cm_img[ $gameSystem._drill_cm1_actor_id ] = ImageManager.loadPicture(DrillUp.battle_pic_list[ $gameSystem._drill_cm1_new_pic_id ]);
					this._sprite_actor_cm.bitmap = this._actor_cm_img[actor_id];
				}
				if( $gameSystem._drill_cm2_change ){
					$gameSystem._drill_cm2_change = false;
					this._actor_cm2_img[ $gameSystem._drill_cm2_actor_id ] = ImageManager.loadPicture(DrillUp.battle_pic_list[ $gameSystem._drill_cm2_new_pic_id ]);
					this._sprite_actor_cm_lay.bitmap = this._actor_cm2_img[actor_id];
				}
				if( $gameSystem._drill_cm12_reset ){
					$gameSystem._drill_cm12_reset = false;
					this._actor_cm_img[ $gameSystem._drill_cm12_actor_id ] = this._actor_cm_img[actor_id] = ImageManager.loadPicture(Moghunter.actor_cm_list[actor_id]);
					this._actor_cm2_img[ $gameSystem._drill_cm12_actor_id ] = this._actor_cm2_img[actor_id] = ImageManager.loadPicture(Moghunter.actor_cm2_list[actor_id]);
					this._sprite_actor_cm.bitmap = this._actor_cm_img[actor_id];
					this._sprite_actor_cm_lay.bitmap = this._actor_cm2_img[actor_id];
				}
			};	
		}
		_drill_actor_cm_update.call(this);
	}
	
	//==============================
	// * Actor CM Refresh
	//==============================
	var _drill_actor_cm_refresh = Actor_CMPicture.prototype.actor_cm_refresh;
	Actor_CMPicture.prototype.actor_cm_refresh = function() {
		if( $gameSystem._drill_cm1_change ){
			$gameSystem._drill_cm1_change = false;
			this._actor_cm_img[ $gameSystem._drill_cm1_actor_id ] = ImageManager.loadPicture(DrillUp.battle_pic_list[ $gameSystem._drill_cm1_new_pic_id ]);
		}
		if( $gameSystem._drill_cm2_change ){
			$gameSystem._drill_cm2_change = false;
			this._actor_cm2_img[ $gameSystem._drill_cm2_actor_id ] = ImageManager.loadPicture(DrillUp.battle_pic_list[ $gameSystem._drill_cm2_new_pic_id ]);
		}
		if( $gameSystem._drill_cm12_reset ){
			$gameSystem._drill_cm12_reset = false;
			this._actor_cm_img[ $gameSystem._drill_cm12_actor_id ] = null;
			this._actor_cm2_img[ $gameSystem._drill_cm12_actor_id ] = null;
		}
		_drill_actor_cm_refresh.call(this);
	};
}

//=============================================================================
// ** 角色窗口
//=============================================================================

if(Imported.MOG_BattleHud){
	
	//==============================
	// * Update Face
	//==============================
	var _drill_Battle_Hud_face_update = Battle_Hud.prototype.update_face;
	Battle_Hud.prototype.update_face = function() {
		if (!this._face) {return};
		if ( $gameSystem._drill_bHud_change && this._battler._actorId == $gameSystem._drill_bHud_face_id ) {
			$gameSystem._drill_bHud_change = false;
			this._face.bitmap = ImageManager.loadBHud(DrillUp.battle_face_list[ $gameSystem._drill_bHud_new_face_id ]);
			this._face_data[5] = -1;
		};
		if ( $gameSystem._drill_bHud_reset && this._battler._actorId == $gameSystem._drill_bHud_reset_id ) {
			$gameSystem._drill_bHud_reset = false;
			this._face.bitmap = ImageManager.loadBHud(Moghunter.actFace_list[this._battler._actorId]);
			this._face_data[5] = -1;
		}
		_drill_Battle_Hud_face_update.call(this);
	};
}
